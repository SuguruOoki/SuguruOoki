# Next Engine 配送設定
# ================================
# 楽天市場・Amazon連携用

shipping:
  # 配送業者設定
  carriers:
    - carrier_id: "yamato"
      name: "ヤマト運輸"
      enabled: true
      api_integration: true
      tracking_url_template: "https://jizen.kuronekoyamato.co.jp/jizen/servlet/crjz.b.NQ0010?id={tracking_number}"

    - carrier_id: "sagawa"
      name: "佐川急便"
      enabled: true
      api_integration: true
      tracking_url_template: "https://k2k.sagawa-exp.co.jp/p/web/okurijosearch.do?okurijoNo={tracking_number}"

    - carrier_id: "japan_post"
      name: "日本郵便"
      enabled: true
      api_integration: false
      tracking_url_template: "https://trackings.post.japanpost.jp/services/srv/search/?requestNo1={tracking_number}"

  # デフォルト配送業者
  default_carrier: "yamato"

  # 配送方法マッピング
  delivery_methods:
    - method_id: "standard"
      name: "通常配送"
      carrier: "yamato"
      service_type: "takkyubin"
      estimated_days: 2-3

    - method_id: "express"
      name: "お急ぎ便"
      carrier: "yamato"
      service_type: "time_service"
      estimated_days: 1

    - method_id: "mail"
      name: "メール便"
      carrier: "japan_post"
      service_type: "yu_packet"
      estimated_days: 3-5

  # モール別配送設定
  mall_settings:
    rakuten:
      # 楽天の配送方法とのマッピング
      method_mapping:
        "通常配送": "standard"
        "お急ぎ便": "express"
        "メール便": "mail"
      # あす楽対応
      asuraku_enabled: false
      asuraku_cutoff_time: "12:00"

    amazon:
      # Amazonの配送方法とのマッピング
      method_mapping:
        "Standard": "standard"
        "Expedited": "express"
      # お届け日指定
      delivery_date_enabled: true

  # 自動化設定
  automation:
    # 送り状自動発行
    auto_issue_slip: true
    # 出荷通知自動送信
    auto_ship_notification: true
    # 追跡番号自動登録
    auto_register_tracking: true
    # ステータス自動更新
    auto_status_update: true

  # 送り状発行設定
  slip_settings:
    # 発行タイミング
    issue_timing: "on_order_confirm"  # on_order_confirm, on_picking_complete, manual
    # 印刷設定
    print_format: "A4"
    copies: 1

  # 出荷完了処理
  completion:
    # 出荷完了時のアクション
    on_complete:
      - update_order_status
      - send_tracking_email
      - sync_to_malls
    # メール通知テンプレート
    email_template: "shipping_complete"

# 配送料金設定
shipping_fees:
  calculation_method: "weight_based"  # weight_based, size_based, fixed

  # 重量別料金（例）
  weight_tiers:
    - max_weight_kg: 2
      fee: 600
    - max_weight_kg: 5
      fee: 800
    - max_weight_kg: 10
      fee: 1000

  # 送料無料条件
  free_shipping:
    enabled: true
    threshold: 5000  # 5000円以上で送料無料

# オープンロジ連携設定
# ================================
# 物流代行サービス「オープンロジ」との連携
openlogi:
  # 基本設定
  enabled: true
  default_service: true  # デフォルトで利用（確認あり）

  # 認証情報（環境変数から取得）
  auth:
    api_key_env: "OPENLOGI_API_KEY"
    company_id_env: "OPENLOGI_COMPANY_ID"
    api_endpoint: "https://api.openlogi.com/v1"

  # 本番環境チェック設定（重要）
  # ================================
  # テスト環境でのオープンロジ連携を防止
  environment_check:
    # 本番環境のみで実行を許可
    production_only: true

    # 本番環境の判定条件
    production_indicators:
      # Next Engine APIエンドポイントが本番用であること
      next_engine_api_url: "https://api.next-engine.org/api_v1_login"
      # 環境変数が本番設定であること
      environment_var: "NEXT_ENGINE_ENV"
      environment_value: "production"

    # テスト環境の検出パターン
    test_environment_patterns:
      # CLIENT_IDにテストパターンが含まれている
      - pattern: "test_"
        field: "client_id"
        description: "CLIENT_IDに'test_'プレフィックスがある"

      # CLIENT_IDにサンプルパターンが含まれている
      - pattern: "sample"
        field: "client_id"
        description: "CLIENT_IDに'sample'が含まれる"

      # API URLがテストエンドポイント
      - pattern: "/test/"
        field: "api_url"
        description: "API URLにテストパスが含まれる"

      # 環境変数が明示的にテスト
      - pattern: "test|development|dev|staging"
        field: "environment"
        description: "環境変数がテスト環境を示している"

    # ブロック時の動作
    on_test_environment_detected:
      action: "block"  # block, warn, allow
      message: |
        ⚠️ テスト環境でのオープンロジ連携は禁止されています

        オープンロジは実際の物流サービスであり、テスト環境から
        出荷指示を送信すると実際の出荷処理が実行されてしまいます。

        本番環境の認証情報を設定してから再度実行してください。

        現在の環境: テスト環境
        必要な環境: 本番環境

      # 強制実行オプション（デバッグ用、本番では無効化推奨）
      allow_override: false
      override_env_var: "OPENLOGI_FORCE_ALLOW_TEST"  # trueで強制実行（非推奨）

  # 自動化設定
  automation:
    # 出荷指示の自動送信
    auto_ship_instruction: true
    # ユーザー確認を挟む（重要）
    require_confirmation: true
    confirmation_timeout_hours: 24  # 24時間以内に確認がない場合は自動承認

    # 自動送信条件
    auto_send_conditions:
      # 受注ステータスが「出荷待ち」の場合のみ
      order_status: ["shipping_pending", "payment_confirmed"]
      # 在庫が確保されている
      stock_secured: true
      # 配送先住所が完全
      address_complete: true
      # オープンロジ対応商品のみ
      openlogi_compatible_only: true

  # 確認フロー設定
  confirmation:
    # 確認方法
    method: "interactive"  # interactive, email, webhook
    # 確認時に表示する情報
    display_info:
      - order_summary
      - shipping_address
      - item_list
      - estimated_cost
      - delivery_date
    # 自動承認条件（オプション）
    auto_approve_if:
      total_amount_under: 100000  # 10万円未満は自動承認
      regular_customer: false  # リピーター顧客は自動承認（falseで無効）

  # 出荷指示送信設定
  ship_instruction:
    # バッチ処理
    batch_enabled: true
    batch_size: 50  # 一度に50件まで処理
    batch_interval_minutes: 60  # 1時間ごとに実行

    # 送信タイミング
    send_timing: "on_confirmation"  # on_order, on_confirmation, scheduled
    scheduled_time: "10:00"  # scheduledの場合の実行時刻

    # リトライ設定
    retry:
      enabled: true
      max_attempts: 3
      interval_minutes: 10

  # 在庫連携
  inventory_sync:
    enabled: true
    sync_interval_hours: 1  # 1時間ごとに同期
    # 在庫更新時のアクション
    on_stock_update:
      - update_next_engine
      - notify_low_stock

  # ステータス同期
  status_sync:
    enabled: true
    # オープンロジ→Next Engineのステータスマッピング
    status_mapping:
      "received": "openlogi_received"  # 出荷指示受領
      "picking": "openlogi_picking"    # ピッキング中
      "packing": "openlogi_packing"    # 梱包中
      "shipped": "shipped"              # 出荷完了
      "cancelled": "cancelled"          # キャンセル

    # 同期間隔
    sync_interval_minutes: 30

  # 配送業者マッピング
  carrier_mapping:
    # オープンロジが使用する配送業者をNext Engineの業者IDにマッピング
    openlogi_yamato: "yamato"
    openlogi_sagawa: "sagawa"
    openlogi_yupack: "japan_post"

  # エラーハンドリング
  error_handling:
    # エラー時の通知
    notify_on_error: true
    notification_email_env: "OPENLOGI_ERROR_NOTIFICATION_EMAIL"

    # エラー時のフォールバック
    fallback:
      # API失敗時の優先順位
      priority:
        - browser_automation  # まずブラウザ自動操作を試行
        - manual_shipping     # それでも失敗したら手動処理

      # ブラウザ自動操作フォールバック
      browser_automation:
        enabled: true
        # 詳細設定は openlogi-config.yaml を参照
        config_file: "./openlogi-config.yaml"
        # 連続APIエラー回数でブラウザ操作に切り替え
        trigger_on_consecutive_errors: 3
        # ブラウザ操作失敗時の動作
        on_browser_failure: "manual_shipping"  # manual_shipping, skip, retry_api

      # 手動処理フォールバック
      manual_shipping:
        enabled: true
        # 通知方法
        notification: "email"  # email, slack, webhook

  # 料金設定
  pricing:
    # 基本保管料
    storage_fee_per_item_per_month: 10
    # 出荷手数料
    shipping_fee_per_order: 200
    # 梱包資材費
    packing_material_fee: 50

    # 料金計算に含める
    include_in_calculation: true

  # ログ・レポート
  logging:
    enabled: true
    log_file: "./logs/openlogi-integration.log"
    # レポート生成
    generate_reports: true
    report_interval: "monthly"
    report_output_dir: "./logs/openlogi-reports/"
