name: Collect Business Ideas

on:
  schedule:
    # æ¯æ—¥æœ9æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ = UTC 0:00
    - cron: '0 0 * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

defaults:
  run:
    working-directory: business-idea-hunter

jobs:
  collect:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Run collector
        id: collector
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: |
          # å‡ºåŠ›ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          npm start 2>&1 | tee collector-output.log

          # ã‚µãƒãƒªãƒ¼æƒ…å ±ã‚’æŠ½å‡º
          TOTAL_ITEMS=$(grep -oP 'Total: \K\d+' collector-output.log || echo "0")
          IDEAS_COUNT=$(grep -oP 'ğŸ’¡ \K\d+' collector-output.log || echo "0")
          HIGH_COUNT=$(grep -oP 'High: \K\d+' collector-output.log || echo "0")
          MEDIUM_COUNT=$(grep -oP 'Medium: \K\d+' collector-output.log || echo "0")
          LOW_COUNT=$(grep -oP 'Low: \K\d+' collector-output.log || echo "0")

          # GitHub Outputsã«è¨­å®š
          echo "total_items=$TOTAL_ITEMS" >> $GITHUB_OUTPUT
          echo "ideas_count=$IDEAS_COUNT" >> $GITHUB_OUTPUT
          echo "high_count=$HIGH_COUNT" >> $GITHUB_OUTPUT
          echo "medium_count=$MEDIUM_COUNT" >> $GITHUB_OUTPUT
          echo "low_count=$LOW_COUNT" >> $GITHUB_OUTPUT

      - name: Notify Slack on Success
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
          TOTAL_ITEMS: ${{ steps.collector.outputs.total_items }}
          IDEAS_COUNT: ${{ steps.collector.outputs.ideas_count }}
          HIGH_COUNT: ${{ steps.collector.outputs.high_count }}
          MEDIUM_COUNT: ${{ steps.collector.outputs.medium_count }}
          LOW_COUNT: ${{ steps.collector.outputs.low_count }}
        run: |
          # Notionãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹URLã‚’ç”Ÿæˆï¼ˆãƒã‚¤ãƒ•ãƒ³ã‚’é™¤å»ï¼‰
          NOTION_DB_URL="https://www.notion.so/${NOTION_DATABASE_ID//-/}"

          # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ
          if [ "$IDEAS_COUNT" = "0" ]; then
            MESSAGE="ğŸ“Š *Business Idea Hunter å®Œäº†*\n\nåé›†ã‚¢ã‚¤ãƒ†ãƒ : ${TOTAL_ITEMS}ä»¶\næ–°è¦ã‚¢ã‚¤ãƒ‡ã‚¢: ãªã—\n\n_${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}_"
          else
            MESSAGE="ğŸ¯ *Business Idea Hunter å®Œäº†*\n\n*åé›†çµæœ*\nâ€¢ åé›†ã‚¢ã‚¤ãƒ†ãƒ : ${TOTAL_ITEMS}ä»¶\nâ€¢ æŠ½å‡ºã‚¢ã‚¤ãƒ‡ã‚¢: ${IDEAS_COUNT}ä»¶\n\n*ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«åˆ¥*\nâ€¢ ğŸ”´ High: ${HIGH_COUNT}ä»¶\nâ€¢ ğŸŸ¡ Medium: ${MEDIUM_COUNT}ä»¶\nâ€¢ ğŸŸ¢ Low: ${LOW_COUNT}ä»¶\n\nğŸ“ *Notionã§ç¢ºèª*\n${NOTION_DB_URL}\n\n_Workflow: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}_"
          fi

          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"text\": \"$MESSAGE\"}"

      - name: Notify Slack on Failure
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          MESSAGE="âŒ *Business Idea Hunter å¤±æ•—*\n\nå®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"text\": \"$MESSAGE\"}"

      - name: Summary
        if: always()
        run: |
          echo "Collection completed at $(date)"
